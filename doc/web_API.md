# mtanalyze Web API

The web API is for listing server status on your web page. The
mtanalyze project provides both the frontend (js) and backend (json
generated using php).


## API endpoints
Each of the following headings must be queryable URLs under the
/api route (or other route defined in your HTML if differs from the
example above).

### status.json
(and status.php)
To use mtanalyze.js in your website to show the status of each server,
you must be using the minebest framework. The script discovers each
server using the json returned by the api endpoint.

The JSON file can be generated by:
- [../scripts/cron.hourly/update-server-status.sh](../scripts/cron.hourly/update-server-status.sh)
  - or status.php. See [status.php](#status.php)

Regardless of how it is generated, the **status.json** file must have:
- a 'servers' key with a list of objects where each has:
  - 'running' boolean
  - 'name': (string) the name of the server to display in the list
  - 'port': (string or int) the port number
  - 'host' (optional): (string) The host (If doesn't evaluate to true [isn't "truthy"], default_server_host is used instead).
- (optional) 'error' key with an error string (should be set if 'server' is not set or is incomplete)

If you are using a different server to list servers (js) than the one
hosting the json (and php), see "[Error: failed to fetch](#error-failed-to-fetch)"
to prevent the error.


## Backend installation
- Copy/symlink [../api/status.php](../api/status.php) to your website
  such as in an /api subdirectory (In the example code further up, the
  status.php file and json file it generates are installed in the /api
  subdirectory/route of your main website URL).

### status.php
This script calls **status.php**, since a web page calling that file
causes the result of shell_exec to be blank. That may be solved using
server settings, but isn't the best for security. Also, before doing
so, ensure that caching implemented in your version of status.php.

### update-server-status.sh
NOTE: If your server settings allow running and getting output from
status.php, you don't need to use update-server-status.sh nor
mtanalyze.rc at all.

- Copy [../scripts/cron.hourly/update-server-status.sh](../scripts/cron.hourly/update-server-status.sh) to /etc/cron.hourly or an equivalent (such as using crontab to run it more frequently). Edit the script and:
  - Change `WEB_USER` and `WEB_HOME` to the correct directories if they
    differ on your server.
- Create a file called $WEB_HOME/.config/mtanalyze.rc (where $WEB_HOME is
  your website server user's home directory such as /var/www).
  - It **must** at least contain a MTA_API_DIR setting, but change
    `/var/www/minetest.io` to your actual website location, and if not
    using the /api subdirectory, change that to the directory where you
    are installing the web API:
    `MTA_API_DIR=/var/www/minetest.io/api`
  - You can put the file somewhere else, but then you would have to
    change your copy of update-server-status.sh (don't symlink it if
    syncing with git, since you may change it and prevent `git pull`
    from updating other components) and change the MTA_RC line to match
    the location of your mtanalyze.rc file.
- If you don't want to wait up to an hour for the next hourly run of
  the cron jobs, run the script manually to generate some initial data
  for the web page to use, such as via:
  `sudo /etc/cron.hourly/update-server-status.sh` or wherever you put
  it.

## Frontend installation

The file [../assets/js/mtanalyze.js](../assets/js/mtanalyze.js)
can be used in your web page in order to automatically add
a row to a table of any width (at least 4 columns, 4 recommended) with
the column headers "Name", "Address", "Port", and "Status" or something
similar that describes those values correctly in that order.

The api is installed at HOSTNAME/api in the example below, but:
- The substring "/api" must be changed if you installed it elsewhere.
- The web address (minetest.io in the example) must be changed as well
- The implementation below assumes you've installed
  [../assets/js/mtanalyze.js](../assets/js/mtanalyze.js) at
  assets/js/mtanalyze.js in your website.
- If each of the returned objects (see [status.json](#status.json)) has
  the optional 'host' key (not implemented in mtanalyze) then you do
  not need to provide the last parameter, as it is only a default.
  Otherwise, change "minetest.io" to the hostname of the Minetest
  server.
```HTML
<script type = "text/javascript" src="assets/js/mtanalyze.js"></script>
<script type = "text/javascript">

show_server_rows('https://minetest.io/api', 'servers-tbody', 4, "minetest.io")
// 4 for header_col_count of the actual table
</script>
```

Add a named anchor anywhere on your HTML page for each server, such as:
```HTML
<section>
  <a name="skydoom"></a>
  <h3>SkyDoom</h3>
  <p>This is an archived copy of the old SkyDoom server.</p>
</section>
```
- The name must be the short name used in minebest, not a descriptive name with different case or spaces.

## Troubleshooting

### Error: failed to fetch
If using the js file from a different server than the one with the json
file, the CORS policy of the server with the JSON file must allow the
host that is hosting the js file.

